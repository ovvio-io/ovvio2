const testRecord = JSON.stringify({
  s: { __t: 'E', __v: { ns: 'notes', version: 5 } },
  d: {
    creationDate: { __t: 'D', __v: 1690263626.958 },
    isDeleted: 0,
    lastModified: { __t: 'D', __v: 1690263677.577 },
    createdBy: 'eUnggUUGoOcVvGpssnCxlkvMqg92',
    workspace: 'o7CBHWzTjnXLCpOXYw4x',
    assignees: { __t: 'S', __v: ['eUnggUUGoOcVvGpssnCxlkvMqg92'] },
    attachments: { __t: 'S', __v: [] },
    tags: {},
    type: 'note',
    title: {
      __r: [{ text: 'test note' }],
      __d: {
        root: { children: [{ tagName: 'p', children: [{ __rId: 0 }] }] },
        pointers: {
          __t: 'S',
          __v: [
            {
              key: 'eUnggUUGoOcVvGpssnCxlkvMqg92/g6zlseDWUjLMoSkvpCcI',
              type: 'anchor',
              dir: 0,
              expiration: { __t: 'D', __v: 1690263697.562 },
              node: { __rId: 0 },
              offset: 9,
            },
            {
              key: 'eUnggUUGoOcVvGpssnCxlkvMqg92/g6zlseDWUjLMoSkvpCcI',
              type: 'focus',
              dir: 0,
              expiration: { __t: 'D', __v: 1690263697.562 },
              node: { __rId: 0 },
              offset: 9,
            },
          ],
        },
      },
    },
    body: {
      __r: [{ text: '' }],
      __d: {
        root: {
          children: [
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet dolorem proident utilitatis magnus agris. abutebatur architecto propter ut materia. quam quo aliquip, officii voluptatem. qui pariatur officii eos. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet cum tenetur animi. et laboris aut aspexerat fugiat. ipsa amet quoddam colebatur propter. qui tempore et magna sibi. id ipsum deinde, repellat minim. mollit odit culpa qui aut. adipisci vel delectus, pariatur propagabant. consequatur sibi vero, voluptate consequatur. ipsa colebatur et, pariatur repellendus. dolor ullam consequatur id. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet eius rationem eum. pariatur proident earum ipsum non. veniam in provident, veritatis est. id sunt quia, repellat quid. inventore qui posset divinae sit. incidunt dolore et, in reprehenderit. corporis nuptias a qui illo. Sed se atque, dolore atque. fugit quadam ratione impedit dispersos. ea consectetur non se voluptatem. dolorem quae quae posset. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet caeca materia non. culpa sit mollitia, consectetur et. eligendi haberet iste, At eiusmod. quia velit vel insolentiam. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet possimus mites se eos modo. eam quae rerum culpa quas. voluptatem esse cupidatat laboris culpa. in nisi architecto fugit fugiat. minus rerum propter ac magnus. asperiores qui amet, magnus corporis. nihil et voluptatem a adipisicing. quicquam minim cognovit deserunt numquam. veritatis sed eligendi in. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet enim caeca bestiarum abditos non. facere cognovit adipisicing laboris utilitatis. laborum praecipiendo quisquam dolorum natus. dolores passim quidam, placeat veniam. ad qui anim magni aperiam. et quidam cupidatat, vir asperiores. magni sequi in, nesciunt quisquam. utilitatis excepturi inmanibus, atque irure. repellat posset ea, fuga insolentiam. ab pleraque deserunt, religionis cupidatat. est sapiente qui repellat. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet magni dolorem audientes. elit feris dominatrix, sit in. Quis sapiens dominatrix, hominum viribus. consequuntur omnis utilem rerum. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet aliqua beatae magni nam magnam. ad possimus aperiam Ut fero. quadam qui non, in sed. magnus culpa Neque maxime porro. posset nemo in legitimas administrabant. agris autem molestias, utilitatis magna. honestam Itaque meliorem nostrud quamque. id rationem propagabant materia. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet vagabantur sit veniam. quamque autem aut, est et. iusto blanditiis sit expedita culpa. ipsum temeraria id, animi tenetur. cupidatat administrabant maiores errorem. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet illum quis et quidam suscipit. Excepteur culpa aut natus suscipit. suscipit bestiarum fuga cillum consequatur. fuit officia unde, religionis aspexerat. laborum utilem consequatur, vitam ea. commodo et in, expedita non. voluptates homines res facere Itaque. rem ex et consequatur. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet abditos fero eu. cognovit aliquip facilis quisquam acceperat. id magna sequi, explicabo aspexerat. impedit est ex non inventore. amet non sit, porro nihil. Ut viribus errorem, sed perspiciatis. minim et in, veniam id. materia res placeat, non eaque. Sed odio possimus sunt. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet Neque eveniet explendam nesciunt quidam. aut voluptatem aequabile, Nemo in. eos ea ita, sint abutebatur. omnis consectetur sapiente perferendis. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet fugiat sed cognovit pariatur silvestribus. excepturi qui nihil, est dolores. nihil in sed silvestribus enim. voluptatum cillum in, in ut. reiciendis dolore fero, quo nesciunt. blanditiis quaerat quis, perferendis fuga. ut haberet sed, eu excepturi. ratione laboriosam opportunitas ex. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet ratione nulla et colebatur conpulit. quis inscientiam ducimus, atque corporis. aliquid se repellat homines perferendis. id autem soluta sed qui. a humani ad, sit nulla. optio adipisci dolor nam. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet ius atque aut. satellitibus rerum sed opportunitas rerum. ut feris doloribus, consectetur provident. administrabant dignissimos error humani. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet officia ipsum maximas sint homines. inmanibus est voluptatum, eum divinae. do magna nostrum, mollit autem. et asperiores sunt consequatur placeat. laboris ut elicere occaecati ad. necessitatibus facere facilis, illo et. maxime animi beatae molestiae commodi. ut sit molestiae, dicta perferendis. consectetur vitam sint ut. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet divinae quisquam praecipiendo. cumque Ut ab, divinae praesentium. et studiosius consequatur, temeraria dolor. autem nam eam, tempor ut. rerum nisi ipsum, cupiditas fero. et tempore earum, in honestam. hominum enim deserunt occaecati. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet culpa humani cum. et ex et, non et. est in et, aut vero. caeca videlicet dolorem eiusmod ea. similique mollitia ullam quo voluptatum. quidem quod opportunitas aut. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet officia modi anim voluptas studiosius. viribus doloribus tempus, ratione quasi. voluptates laborum quis, unum rerum. quamque cumque dolor explicabo reprehenderit. maiores nostrud ad, mites quidem. honestam quamque placeat, Et propter. ad anim cum acceperat Ut. mollitia iure humani, quaerat acceperat. nec eos culpa reprehenderit dignissimos. aspernatur feris laboriosam dolore. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet repellat et molestias liberos quia. fugiat enim sint, reddidit earum. magnam eveniet id ut necessitatibus. reprehenderit aliquam commodo viribus dolor. et voluptate et, reprehenderit non. esse reiciendis reddere; culpa. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet non voluptatem sapiens. officia harum illum ita rerum. iste in ipsa perniciosissimis natus. passim esse abditos animi dolore. quibusdam irure ut, Quis ipsum. tenetur victu ut enim quos. illum orationem se, delectus reddere;. sed velit velit, eaque aliqua. aliquam sapiente lorem voluptatum dolore. aut fugiat totam rerum. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet nondum voluptatem ab. primo Duis propagabant consequatur non. dolor quia victu quid dolore. dolorem eos Sed odio inscientiam. id aut in, et facilis. quo deserunt sed, sint errorem. studiosius delectus maxime qui ducimus. sapiens soluta alias labore ex. et corporis unam non se. nisi corporis et expedita. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet facere ex occaecati. magnam quae reprehenderit, culpa acceperat. natus nesciunt quia lorem iste. qui eu aequabile quisquam. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet quadam earum quidam. perferendis in in, optio dolor. expedita cognovit rerum minus quia. quas qui quanta fuga deleniti. quam labore deinde ducimus materia. praesentium non saepe, si ut. voluptas quia se acceperat. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet et et rerum quibusdam commodo. aute temeraria nuptias, audientes non. rem voluptate viderat sit irure. alias reddidit aliqua propter pariatur. ad doloribus doloremque, recusandae pariatur. elicere ad ius viribus tempor. dignissimos dolores res, dignissimos optio. consectetur deleniti atque excepturi. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet est et placeat. religionis et et animi dispersos. modi nulla voluptate, officia esset. consequatur sunt quisquam soluta et. reprehenderit illo et, liberos cupiditate. inesset victu cupiditate magnam. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet fero se congregavit recusandae ratione. ea ad quamque, nihil nobis. aperiam facilis ea voluptate conpulit. perferendis eveniet suscipit cupidatat ius. cognovit cillum conpulit impedit eligendi. deserunt corporis non aut Et. ut eam rem, non propagabant. molestiae quis commodi nemo. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet amet aliquip reiciendis esse dolores. et beatae consequatur, unam et. divinae beatae agros, ducimus sint. do provident quo, temeraria qui. omnis Nemo utilem Excepteur minus. qui culpa perspiciatis, ratione in. et exercitationem qui, a libero. minima fero vel quo. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet et consequatur qui Quis aperiam. voluptatibus nisi ad, viderat corporis. non nihil amet quos in. et numquam earum voluptate totam. voluptatum ad animi, minim et. videlicet perspiciatis nisi, libero propter. repellendus victu propter, rerum officiis. quidam possimus quicquam, dolore nihil. rerum ullamco aliquip, quaerat rerum. asperiores a vitam non. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet hominum ipsum feris voluptatem ea. eos ad Itaque, dolorem consectetur. qui eligendi voluptatibus distinctio corporis. occaecat eveniet Excepteur, eos nihil. acceperat dolores elicere ea blanditiis. id esse satellitibus vagabantur. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet consectetur consequatur officia sit nulla. expedita molestiae est nihil deserunt. molestiae adipisci quo iusto reclamantes. sint quia et ea. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet maiores magnam deleniti. legitimas ex et nulla voluptates. sapiens alias quas victu nulla. veniam fuga eos est dolorum. autem distinctio corrupti, fuga inesset. consequatur autem viribus, officia Ut. propter non reprehenderit et culpa. laboriosam maximas in ipsum repudiandae. dolor et expedita sunt divinae. magnus autem necessitatibus bestiarum. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet ad tempore opportunitas. aut sit magni, quis elit. sapiente liberos occaecat adipisci delectus. consectetur dignissimos et, inventore officii. impedit nec in, nuptias vitam. in voluptatem rerum minim et. administrabant et et, quo adipisicing. beatae ratione in, pariatur consequatur. quas animis fero si eius. quod rerum molestiae aliqua. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet qui honestam acceperat animi voluptas. excepturi saepe et, tempus maxime. ut doloremque dolores, illo officiis. eam sed optio, unde Nemo. omnis laborum quis fugiat in. et voluptate aut, inducens in. molestias honestam laboris, mollit facere. voluptatem eos nihil occaecat repellendus. dolor cupiditas pleraque quos mollit. mollit hic conpulit aut. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet in molestias qui. reclamantes sit reddidit, quis abutebatur. esse deserunt Ut, laboris atque. quas locum At, eaque studiosius. aspexerat elit dispersos, distinctio inesset. quo aut quadam, orationem ullamco. ac inscientiam lorem, amet ut. voluptas ex silvestribus videlicet. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet aute abutebatur perniciosissimis omnis non. quis ullam sunt, nemo qui. quia id rerum mansuetos nobis. eos quid in si bestiarum. est earum placeat, nulla et. in reddidit sint, homines nostrum. in aut iste, accusamus et. velit in nulla soluta rem. atque honestam At ratio dolorum. natus omnis dolores laborum. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet ratione aliquid rerum nam assumenda. nihil omnis ut, studiosius id. rem corporis enim quoddam aut. pariatur pleraque est voluptatem Duis. explendam deserunt pleraque numquam qui. commodo dolor sint, studiosius reddere;. Nemo ut voluptas rerum sit. officia sed nec, a est. reprehenderit mites laudantium veniam. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet in aliquip qui conpulit reddere;. dolore inmanibus repellendus cum voluptatem. Et dolor rerum in esset. magna et sed, inmanibus voluptatem. delectus tempora quis, totam ea. sed in quicquam dolorem. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet nisi voluptates quae repellat eos. reiciendis corporis pleraque, consequatur veritatis. ut quia molestias, viribus cupidatat. reprehenderit atque elit, rem est. utilem agris meliorem, propter iste. nostrum unum enim quo reiciendis. reiciendis religionis sunt et inducens. soluta unde ratione quo. ',
                },
              ],
            },
            {
              tagName: 'p',
              children: [
                {
                  text: 'lorem ipsum dolor sit amet voluptates non conpulit. dolore voluptatem consequat, nec velit. voluptatibus aut Ut, possimus quaerat. et sit atque, et aut. quia debitis odit viribus materia. vagabantur sapiente aut nemo magni. atque non feris, minima quanta. ullamco eu ut modo voluptates. et similique dolore vel veniam. pariatur inducens qui, ea praesentium. illum iste possimus officii. ',
                },
              ],
            },
            { tagName: 'p', children: [{ __rId: 0 }] },
          ],
        },
        pointers: {
          __t: 'S',
          __v: [
            {
              key: 'eUnggUUGoOcVvGpssnCxlkvMqg92/g6zlseDWUjLMoSkvpCcI',
              type: 'anchor',
              dir: 0,
              expiration: { __t: 'D', __v: 1690263697.572 },
              node: { __rId: 0 },
              offset: 0,
            },
            {
              key: 'eUnggUUGoOcVvGpssnCxlkvMqg92/g6zlseDWUjLMoSkvpCcI',
              type: 'focus',
              dir: 0,
              expiration: { __t: 'D', __v: 1690263697.572 },
              node: { __rId: 0 },
              offset: 0,
            },
          ],
        },
      },
    },
    pinnedBy: { __t: 'S', __v: [] },
  },
  v: 13,
  n: true,
});

async function digestMessage(keyPair, message) {
  const msgUint8 = new TextEncoder().encode(message); // encode as (utf-8) Uint8Array
  const msgHashBufffer = await crypto.subtle.digest('SHA-512', msgUint8); // hash the message
  const hashBuffer = await crypto.subtle.sign(
    {
      name: 'ECDSA',
      hash: { name: 'SHA-384' },
    },
    keyPair.privateKey,
    msgHashBufffer
  );
  // const hashArray = Array.from(new Uint8Array(hashBuffer)); // convert buffer to byte array
  // const hashHex = hashArray
  //   .map((b) => b.toString(16).padStart(2, '0'))
  //   .join(''); // convert bytes to hex string
  return hashBuffer;
}

async function verifyMessage(keyPair, message, signature) {
  const msgUint8 = new TextEncoder().encode(message); // encode as (utf-8) Uint8Array  const sigUint8 = new TextEncoder().encode(signature); // encode as (utf-8) Uint8Array
  // const sigUint8 = new TextEncoder().encode(signature); // encode as (utf-8) Uint8Array  const sigUint8 = new TextEncoder().encode(signature); // encode as (utf-8) Uint8Array
  const msgHashBufffer = await crypto.subtle.digest('SHA-512', msgUint8); // hash the message

  let result = await crypto.subtle.verify(
    {
      name: 'ECDSA',
      hash: { name: 'SHA-384' },
    },
    keyPair.publicKey,
    signature,
    msgHashBufffer
  );

  if (!result) {
    console.error('Verify failed');
    return;
  }
}

async function runTest() {
  const keyPair = await crypto.subtle.generateKey(
    {
      name: 'ECDSA',
      namedCurve: 'P-384',
    },
    true,
    ['sign', 'verify']
  );
  const start = Date.now();
  const iterCount = 100000;
  const batchSize = 1000;
  let totalSign = 0;
  let totalVerify = 0;
  console.log('Starting test...');
  for (let batchIdx = 0; batchIdx < iterCount / batchSize; ++batchIdx) {
    const promises = [];
    const batchStart = Date.now();
    for (let i = 0; i < batchSize; ++i) {
      promises.push(digestMessage(keyPair, testRecord));
    }
    const signRes = await Promise.allSettled(promises);
    const verifyStart = Date.now();
    await Promise.allSettled(
      signRes.map((sig) => verifyMessage(keyPair, testRecord, sig.value))
    );
    const batchEnd = Date.now();
    totalSign += verifyStart - batchStart;
    totalVerify += batchEnd - verifyStart;
  }
  const end = Date.now();
  console.log(
    `Total time: ${(end - start) / 1000}sec, Avg: ${
      (end - start) / iterCount
    }ms`
  );
  console.log(
    `Total sign time: ${totalSign / 1000}sec, Avg: ${totalSign / iterCount}ms`
  );
  console.log(
    `Total verify time: ${totalVerify / 1000}sec, Avg: ${
      totalVerify / iterCount
    }ms`
  );
}

runTest();
